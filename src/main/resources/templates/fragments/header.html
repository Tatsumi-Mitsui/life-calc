<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<body>
<header th:fragment="siteHeader(mode)">
    <div class="inner header-grid">
        <!-- 左：ロゴ -->
        <div class="logo">
            <a th:href="@{/variablebudget}">かんたん家計計算</a>
        </div>

        <!-- 右：認証エリア（未ログイン時） + ハンバーガーメニュー -->
        <div class="nav-actions" th:if="${mode} != 'simple'">
            <!-- 未ログイン時（ログインリンクを表示） -->
            <a class="login-link" sec:authorize="isAnonymous()" th:href="@{/auth/login}">ログイン</a>

            <!-- ハンバーガーボタン -->
            <button class="menu-btn" id="menu-toggle" aria-label="メニュー"
                    aria-controls="drawer" aria-expanded="false">
                <i class="fa-solid fa-bars" aria-hidden="true"></i>
            </button>
        </div>
    </div>

    <!-- ドロワー -->
    <nav class="drawer" id="drawer" aria-hidden="true" th:if="${mode} != 'simple'">
        <div class="drawer-content">

            <div class="drawer-top">
                <span class="drawer-top-title">メニュー</span>
                <button class="drawer-close" id="menu-close" aria-label="メニューを閉じる">
                    <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                </button>
            </div>

            <!-- ユーザー情報カード -->
            <section class="drawer-card">
                <!-- 上段：固定ラベル -->
                <div class="card-title">アカウント情報</div>
                
                <!-- 下段：ユーザー名 -->
                <div class="card-row user-info">
                    <span class="value">
                        <!-- 未ログイン時：「ゲスト」 -->
                        <span sec:authorize="isAnonymous()">ゲスト</span>
                        <!-- ログイン時：表示名（nullならユーザー名にフォールバック） -->
                        <span sec:authorize="isAuthenticated()"
                              th:text="${#authentication.principal.displayName != null ? #authentication.principal.displayName : #authentication.name}">
                            user</span>
                    </span>
                </div>

                <div class="card-actions">
                    <!-- 未ログイン時：ログインリンク -->
                    <a class="drawer-link" th:href="@{/auth/login}" sec:authorize="isAnonymous()">ログイン</a>

                    <!-- ログイン時：ログアウト（POSTをリンク風に） -->
                    <form th:action="@{/logout}" method="post" sec:authorize="isAuthenticated()">
                        <th:block th:if="${_csrf != null}">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        </th:block>
                        <button type="submit" class="drawer-link as-text">ログアウト</button>
                    </form>
                </div>
            </section>

            <hr>

            <section class="drawer-section">
                <div class="section-title">計算ツール</div>
                <a th:href="@{/variablebudget}" class="drawer-link">変動費計算</a>
                <!-- 今後の計算画面リンクをここに追加 -->
            </section>
        </div>
    </nav>

    <th:block th:if="${mode} != 'simple'">
        <script th:src="@{/js/menu.js(v=1)}" defer></script>
    </th:block>
</header>
</body>
</html>