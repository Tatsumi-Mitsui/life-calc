<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: siteHead(
	'変動費計算',
	${{'/css/pages/variablebudget.css'}},
	${{'/js/pages/variableBudget.js'}}
)}"></head>

<body>
	<!-- ヘッダー：タイトル/ログイン導線 -->
	<header th:replace="~{fragments/header :: siteHeader}"></header>
	
	<!-- メイン -->
	<main class="page-grid">

		<!-- 中央：メイン（計算） -->
		<section class="main-pane">
			<div class="intro">
				<h2>変動費</h2>
				<p class="description">収入（手取り）と固定費の合計額の差により、使うことのできる変動費の目安を算出します。</p>
			</div>
	
			<!-- 計算フォーム：/calc にPOST。 -->
			<form id="calc-form" th:action="@{/variablebudget/calc}" method="post" th:object="${form}">
				<!-- CSRF（ログイン済みユーザーの権限を使って勝手に操作させる攻撃）の対策用 -->
				<th:block th:if="${_csrf != null}">
					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
				</th:block> 

				<!-- 収入欄 -->
				<div class="input-block">
					<label for="income">収入（手取り）：</label>
					<div class="input-row">
						<span>￥</span>
						<input
							id="income"
							type="number"
							inputmode="numeric"
							min="0"
							step="1"
							th:field="*{income}"
							placeholder="例：100000"
							autocomplete="off" />
					</div>
				</div>
				
				<!-- 固定費リスト（複数行：追加/削除） -->
				<div id="fixed-cost-list">

					<!-- 既存データがある場合：その分だけ描画 -->
					<div th:each="cost, stat : *{fixedCosts}" class="input-block fixed-cost-block">

						<!-- ラベル（上段） -->
						<label th:text="'固定費' + ${stat.index + 1} + '：'">固定費：</label>
					
						<!-- 下段：￥と入力欄を横並び -->
						<div class="input-row">
							<span>￥</span>
							<input
								type="number"
								inputmode="numeric"
								th:field="*{fixedCosts[__${stat.index}__]}"
								min="0"
								step="1"
								placeholder="例：10000"
								autocomplete="off" />
						
							<!-- 削除ボタン（2件目以降のみ表示） -->
							<button type="button" th:if="${stat.index > 0}" onclick="removeCost(this)" class="delete-btn">
								<i class="fa-solid fa-circle-minus icon-minus" aria-hidden="true"></i>
							</button>
						</div>
					
						<!-- サーバー側バリデーションの表示領域 -->
						<div class="field-error" th:errors="*{fixedCosts[__${stat.index}__]}"></div>
					</div>

					<!-- データが空なら初期1行（index=0） -->
					<div th:if="${#lists.isEmpty(form.fixedCosts)}" class="input-block fixed-cost-block">
						<label>固定費1：</label>
						<div class="input-row">
							<span>￥</span>
							<input
								type="number"
								name="fixedCosts[0]"
								inputmode="numeric"
								min="0"
								step="1"
								placeholder="例：10000"
								autocomplete="off" />
						</div>
					</div>
				</div>
				
				<!-- 追加ボタン -->
				<div class="add-button-wrapper">
					<button type="button" id="add-fixed" class="add-btn" onclick="addCost()">
						<i class="fa-solid fa-circle-plus icon-plus" aria-hidden="true"></i>
					</button>
				</div>
			</form>
			
			<!-- 共通アクション行（中央横並び）-->
			<div class="actions">
				<!-- 計算ボタン -->
				<button type="submit" class="submit-btn" form="calc-form">計算する</button>

				<!-- 保存ボタン：/save にPOST。calcフォームの値をJSでコピーして送る -->
				<form id="save-form" th:action="@{/variablebudget/save}" th:object="${form}" method="post" class="form-buttons">
					<!-- CSRF（ログイン済みユーザーの権限を使って勝手に操作させる攻撃）の対策用 -->
					<th:block th:if="${_csrf != null}">
						<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
					</th:block>
					<button type="button" id="save-button" class="save-btn">保存する</button>
				</form>
			</div>
			
			<!-- 計算結果（順序：見出し → 固定費合計 → 使える変動費） -->
			<div class="result-area">
				<h3>計算結果</h3>

				<!-- 固定費合計 -->
				<div class="result-row">
					<span>固定費の合計：</span>
					<span class="value">
						￥<span th:text="${#numbers.formatInteger(form.fixedCostTotal != null ? form.fixedCostTotal : 0, 0, 'COMMA')}">0</span>
					</span>
				</div>
					
				<!-- 使える変動費 -->				
				<div class="result-row">
  					<span>使える変動費：</span>
  					<span class="value"
        				  th:classappend="${form.resultVariable != null} ? (${form.resultVariable} < 0 ? 'negative' : 'positive') : ''">
    					<span th:if="${form.resultVariable != null and form.resultVariable < 0}">-</span>
    					￥<span th:text="${#numbers.formatInteger(T(java.lang.Math).abs(form.resultVariable != null ? form.resultVariable : 0), 0, 'COMMA')}">0</span>
  					</span>
				</div>
			</div>

			<!-- 固定費入力の追加行テンプレ： JSで __INDEX__/__NUM__ を置換 -->
			<!-- 定石として"クライアントで後から複製するテンプレ"でThymeleaf式は入れない-->
			<template id="fixed-cost-template">
				<div class="input-block fixed-cost-block">
					<!-- ラベル（上段） -->
					<label>固定費__NUM__：</label>
					<div class="input-row">
						<span>￥</span>
						<input 
							type="number"
							name="fixedCosts[__INDEX__]"
							inputmode="numeric"
							min="0"
							step="1"
							placeholder="例：10000"
							autocomplete="off"
						/>

						<!-- 削除ボタン（2件目以降用） -->
						<button type="button" class="delete-btn" onclick="removeCost(this)">
							<i class="fa-solid fa-circle-minus icon-minus"></i>
						</button>
					</div>

					<!-- サーバー側バリデーションの表示領域 -->
					<div class="field-error"></div>
				</div>
			</template>
		</section>

		<!-- 右側：履歴表示（保存時のみ増える） -->
		<aside class="history-pane">
			<div class="history-header">
				<h3>履歴</h3>
				<div class="csv-placeholder"><!-- あとでCSVボタンを置く --></div>
			</div>

			<div class="history-list">
				<!-- 履歴がないとき -->
				<div class="history-empty" th:if="${#lists.isEmpty(histories)}">履歴はありません</div>
				
				<!-- 履歴カード -->
				<div class="history-card" th:each="h : ${histories}">	
					<!-- 保存日 -->
					<div class="row">
						<span>保存日：</span>
						<span th:text="${#temporals.format(h.savedAt, 'yyyy/MM/dd HH:mm')}">2025/08/20 12:00</span>
					</div>

					<!-- 収入 -->
					<div class="row">
						<span>収入：</span>
						<span class="num">
							￥<span th:text="${#numbers.formatInteger((h.income != null ? h.income : 0), 0, 'COMMA')}">200,000</span>
						</span>
					</div>
					
					<!-- 固定費合計 -->
					<div class="row">
						<span>固定費合計：</span>
						<span class="num">
							￥<span th:text="${#numbers.formatInteger((h.fixedCostTotal != null ? h.fixedCostTotal : 0), 0, 'COMMA')}">125,000</span>
						</span>
					</div>
					
					<!-- 計算結果 -->
					<div class="row result">
						<span >使える変動費：</span>
						<span class="num"
							  th:classappend="${h.resultVariable != null and h.resultVariable < 0} ? 'negative' :
							  				 (${h.resultVariable != null and h.resultVariable > 0} ? 'positive' : '')">
							<span th:if="${h.resultVariable != null and h.resultVariable < 0}">-</span>
							 ￥<span th:text="${#numbers.formatInteger(T(java.lang.Math).abs(h.resultVariable != null ? h.resultVariable : 0), 0, 'COMMA')}">175,000</span>
						</span>
					</div>

					<!-- 詳細表示 -->
					<!-- <a class="more" href="#" aria-disabled="true">＋詳細</a> -->
					
					<!-- 履歴カードの個別削除フォーム -->
					<form th:action="@{/variablebudget/history/delete/{id}(id=${h.id})}" method="post" class="mt-2">
						<!-- CSRF（ログイン済みユーザーの権限を使って勝手に操作させる攻撃）の対策用 -->
						<th:block th:if="${_csrf != null}">
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
						</th:block>
						<button type="submit" class="delete-btn">削除</button>	
					</form>
				</div>
			</div>
		</aside>
	</main>
	
	<!-- フッター -->
	<footer th:replace="~{fragments/footer :: siteFooter}"></footer>
	
</body>
</html>